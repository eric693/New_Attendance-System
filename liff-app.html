<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡ºå‹¤ç®¡å®¶ - LINE ç‰ˆ</title>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1rem;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .punch-btn {
            width: 100%;
            padding: 1rem;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.125rem;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }

        .punch-btn:active {
            transform: scale(0.98);
        }

        .punch-in {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .punch-out {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-normal {
            background: #d1fae5;
            color: #065f46;
        }

        .status-late {
            background: #fee2e2;
            color: #991b1b;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .history-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <!-- è¼‰å…¥ä¸­ -->
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p style="color: white;">è¼‰å…¥ä¸­...</p>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div id="main-content" style="display: none;">
        <!-- ä½¿ç”¨è€…è³‡è¨Šå¡ç‰‡ -->
        <div class="card">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <img id="user-picture" src="" alt="é ­åƒ" 
                     style="width: 60px; height: 60px; border-radius: 50%;">
                <div>
                    <h2 id="user-name" style="font-size: 1.25rem; font-weight: bold; margin: 0;">è¼‰å…¥ä¸­...</h2>
                    <p id="company-name" style="color: #6b7280; margin: 0.25rem 0 0 0;">å…¬å¸åç¨±</p>
                </div>
            </div>
        </div>

        <!-- ä»Šæ—¥ç‹€æ…‹å¡ç‰‡ -->
        <div class="card">
            <h3 style="font-weight: bold; margin-bottom: 1rem;">ğŸ“… ä»Šæ—¥ç‹€æ…‹</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <p style="color: #6b7280; font-size: 0.875rem;">ä¸Šç­æ‰“å¡</p>
                    <p id="today-punch-in" style="font-weight: bold; font-size: 1.25rem; color: #10b981;">--:--</p>
                </div>
                <div>
                    <p style="color: #6b7280; font-size: 0.875rem;">ä¸‹ç­æ‰“å¡</p>
                    <p id="today-punch-out" style="font-weight: bold; font-size: 1.25rem; color: #ef4444;">--:--</p>
                </div>
            </div>
            <div style="margin-top: 1rem;">
                <p style="color: #6b7280; font-size: 0.875rem;">å·¥ä½œæ™‚æ•¸</p>
                <p id="work-hours" style="font-weight: bold; font-size: 1.5rem;">-- å°æ™‚</p>
            </div>
        </div>

        <!-- æ‰“å¡æŒ‰éˆ• -->
        <div class="card">
            <h3 style="font-weight: bold; margin-bottom: 1rem;">â° å¿«é€Ÿæ‰“å¡</h3>
            
            <!-- äººè‡‰è¾¨è­˜æ‰“å¡æŒ‰éˆ• -->
            <button id="face-punch-btn" class="punch-btn" 
                    style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); margin-bottom: 1rem;">
                ğŸ“¸ äººè‡‰è¾¨è­˜æ‰“å¡
            </button>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <button id="punch-in-btn" class="punch-btn punch-in">
                    ğŸŒ… ä¸Šç­æ‰“å¡
                </button>
                <button id="punch-out-btn" class="punch-btn punch-out">
                    ğŸŒ† ä¸‹ç­æ‰“å¡
                </button>
            </div>
        </div>

        <!-- æœ¬é€±æ‰“å¡è¨˜éŒ„ -->
        <div class="card">
            <h3 style="font-weight: bold; margin-bottom: 1rem;">ğŸ“‹ æœ¬é€±è¨˜éŒ„</h3>
            <div id="week-records">
                <p style="color: #6b7280; text-align: center;">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <!-- å¿«æ·åŠŸèƒ½ -->
        <div class="card">
            <h3 style="font-weight: bold; margin-bottom: 1rem;">âš¡ å¿«æ·åŠŸèƒ½</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                <button onclick="openSalary()" 
                        style="padding: 1rem; background: #f3f4f6; border-radius: 12px; border: none; font-weight: 600;">
                    ğŸ’° è–ªè³‡æŸ¥è©¢
                </button>
                <button onclick="openLeave()" 
                        style="padding: 1rem; background: #f3f4f6; border-radius: 12px; border: none; font-weight: 600;">
                    ğŸ“ è«‹å‡ç”³è«‹
                </button>
                <button onclick="openOvertime()" 
                        style="padding: 1rem; background: #f3f4f6; border-radius: 12px; border: none; font-weight: 600;">
                    â° åŠ ç­ç”³è«‹
                </button>
                <button onclick="openWeb()" 
                        style="padding: 1rem; background: #f3f4f6; border-radius: 12px; border: none; font-weight: 600;">
                    ğŸŒ å®Œæ•´ç‰ˆç¶²é 
                </button>
            </div>
        </div>
    </div>

    <!-- äººè‡‰è¾¨è­˜æ¨¡çµ„ï¼ˆéš±è—ï¼‰ -->
    <input type="file" id="face-image-input" accept="image/*" capture="user" style="display: none;">

    <script src="config.js"></script>
    <script>
        let liffId = '2008234086-3mrZl8yk'; // æ›¿æ›æˆä½ çš„ LIFF ID
        let userProfile = null;
        let sessionToken = null;

        // ==================== LIFF åˆå§‹åŒ– ====================
        
        async function initializeLIFF() {
            try {
                document.getElementById('loading').style.display = 'block';
                
                await liff.init({ liffId: liffId });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                // å–å¾—ä½¿ç”¨è€…è³‡è¨Š
                userProfile = await liff.getProfile();
                
                console.log('ğŸ‘¤ ä½¿ç”¨è€…è³‡è¨Š:', userProfile);
                
                // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
                document.getElementById('user-name').textContent = userProfile.displayName;
                document.getElementById('user-picture').src = userProfile.pictureUrl;
                
                // å–å¾— Session Token
                await getSessionToken();
                
                // è¼‰å…¥ä»Šæ—¥ç‹€æ…‹
                await loadTodayStatus();
                
                // è¼‰å…¥æœ¬é€±è¨˜éŒ„
                await loadWeekRecords();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                
            } catch (error) {
                console.error('âŒ LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                alert('åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°é–‹å•Ÿ');
            }
        }

        // ==================== API å‘¼å« ====================
        
        async function getSessionToken() {
            try {
                const idToken = liff.getIDToken();
                
                const response = await fetch(`${API_CONFIG.apiUrl}?action=liffLogin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        idToken: idToken,
                        userId: userProfile.userId,
                        displayName: userProfile.displayName,
                        pictureUrl: userProfile.pictureUrl
                    })
                });
                
                const data = await response.json();
                
                if (data.ok && data.token) {
                    sessionToken = data.token;
                    
                    // å–å¾—å…¬å¸è³‡è¨Š
                    if (data.companyName) {
                        document.getElementById('company-name').textContent = data.companyName;
                    }
                    
                    console.log('âœ… Session Token å·²å–å¾—');
                } else {
                    throw new Error('ç„¡æ³•å–å¾— Session Token');
                }
                
            } catch (error) {
                console.error('âŒ å–å¾— Token å¤±æ•—:', error);
                alert('ç™»å…¥å¤±æ•—ï¼Œè«‹é‡æ–°é–‹å•Ÿ');
            }
        }

        async function callAPI(action, extraParams = {}) {
            const response = await fetch(`${API_CONFIG.apiUrl}?action=${action}&token=${sessionToken}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(extraParams)
            });
            
            return await response.json();
        }

        // ==================== æ‰“å¡åŠŸèƒ½ ====================
        
        async function doPunch(type) {
            try {
                if (!navigator.geolocation) {
                    alert('æ‚¨çš„è£ç½®ä¸æ”¯æ´å®šä½åŠŸèƒ½');
                    return;
                }
                
                const button = type === 'ä¸Šç­' 
                    ? document.getElementById('punch-in-btn')
                    : document.getElementById('punch-out-btn');
                
                button.disabled = true;
                button.textContent = 'æ‰“å¡ä¸­...';
                
                // å–å¾—ä½ç½®
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject);
                });
                
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // å‘¼å«æ‰“å¡ API
                const result = await callAPI('punch', {
                    type: type,
                    lat: lat,
                    lng: lng,
                    datetime: new Date().toISOString()
                });
                
                if (result.ok) {
                    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                    liff.sendMessages([{
                        type: 'text',
                        text: `âœ… ${type}æ‰“å¡æˆåŠŸï¼\næ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`
                    }]);
                    
                    // é‡æ–°è¼‰å…¥ä»Šæ—¥ç‹€æ…‹
                    await loadTodayStatus();
                    
                    alert(`${type}æ‰“å¡æˆåŠŸï¼`);
                } else {
                    alert(`æ‰“å¡å¤±æ•—ï¼š${result.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
                
            } catch (error) {
                console.error('âŒ æ‰“å¡å¤±æ•—:', error);
                alert('æ‰“å¡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                const button = type === 'ä¸Šç­' 
                    ? document.getElementById('punch-in-btn')
                    : document.getElementById('punch-out-btn');
                
                button.disabled = false;
                button.textContent = type === 'ä¸Šç­' ? 'ğŸŒ… ä¸Šç­æ‰“å¡' : 'ğŸŒ† ä¸‹ç­æ‰“å¡';
            }
        }

        // ==================== äººè‡‰è¾¨è­˜æ‰“å¡ ====================
        
        async function doFacePunch() {
            try {
                // è§¸ç™¼ç›¸æ©Ÿæ‹ç…§
                document.getElementById('face-image-input').click();
                
            } catch (error) {
                console.error('âŒ äººè‡‰è¾¨è­˜æ‰“å¡å¤±æ•—:', error);
                alert('äººè‡‰è¾¨è­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        // è™•ç†æ‹ç…§å¾Œçš„åœ–ç‰‡
        document.getElementById('face-image-input').addEventListener('change', async (e) => {
            try {
                const file = e.target.files[0];
                if (!file) return;
                
                document.getElementById('face-punch-btn').disabled = true;
                document.getElementById('face-punch-btn').textContent = 'ğŸ” è¾¨è­˜ä¸­...';
                
                // è½‰æ›æˆ Base64
                const base64Image = await fileToBase64(file);
                
                // å–å¾—ä½ç½®
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject);
                });
                
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // å‘¼å«äººè‡‰è¾¨è­˜æ‰“å¡ API
                const result = await callAPI('facePunch', {
                    image: base64Image,
                    lat: lat,
                    lng: lng,
                    datetime: new Date().toISOString()
                });
                
                if (result.ok) {
                    liff.sendMessages([{
                        type: 'text',
                        text: `âœ… äººè‡‰è¾¨è­˜æ‰“å¡æˆåŠŸï¼\n${result.punchType}æ‰“å¡\næ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}\nä¿¡å¿ƒåº¦ï¼š${(result.confidence * 100).toFixed(1)}%`
                    }]);
                    
                    await loadTodayStatus();
                    alert(`äººè‡‰è¾¨è­˜æˆåŠŸï¼\n${result.punchType}æ‰“å¡å®Œæˆ`);
                } else {
                    alert(`è¾¨è­˜å¤±æ•—ï¼š${result.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
                
            } catch (error) {
                console.error('âŒ äººè‡‰è¾¨è­˜å¤±æ•—:', error);
                alert('è¾¨è­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                document.getElementById('face-punch-btn').disabled = false;
                document.getElementById('face-punch-btn').textContent = 'ğŸ“¸ äººè‡‰è¾¨è­˜æ‰“å¡';
            }
        });

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ==================== è¼‰å…¥è³‡æ–™ ====================
        
        async function loadTodayStatus() {
            try {
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0];
                
                const result = await callAPI('getTodayPunch', {
                    date: dateStr
                });
                
                if (result.ok && result.data) {
                    const punchIn = result.data.find(r => r.type === 'ä¸Šç­');
                    const punchOut = result.data.find(r => r.type === 'ä¸‹ç­');
                    
                    document.getElementById('today-punch-in').textContent = 
                        punchIn ? punchIn.time : '--:--';
                    
                    document.getElementById('today-punch-out').textContent = 
                        punchOut ? punchOut.time : '--:--';
                    
                    // è¨ˆç®—å·¥ä½œæ™‚æ•¸
                    if (punchIn && punchOut) {
                        const inTime = new Date(`${dateStr} ${punchIn.time}`);
                        const outTime = new Date(`${dateStr} ${punchOut.time}`);
                        const hours = ((outTime - inTime) / (1000 * 60 * 60)).toFixed(1);
                        document.getElementById('work-hours').textContent = `${hours} å°æ™‚`;
                    }
                }
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥ä»Šæ—¥ç‹€æ…‹å¤±æ•—:', error);
            }
        }

        async function loadWeekRecords() {
            try {
                const result = await callAPI('getWeekRecords');
                
                const container = document.getElementById('week-records');
                container.innerHTML = '';
                
                if (result.ok && result.data && result.data.length > 0) {
                    result.data.forEach(record => {
                        const item = document.createElement('div');
                        item.className = 'history-item';
                        
                        const statusClass = record.status === 'æ­£å¸¸' ? 'status-normal' : 'status-late';
                        
                        item.innerHTML = `
                            <div>
                                <div style="font-weight: 600;">${record.date}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">
                                    ${record.punchIn || '--:--'} - ${record.punchOut || '--:--'}
                                </div>
                            </div>
                            <div>
                                <span class="status-badge ${statusClass}">${record.status}</span>
                            </div>
                        `;
                        
                        container.appendChild(item);
                    });
                } else {
                    container.innerHTML = '<p style="color: #6b7280; text-align: center;">æœ¬é€±ç„¡æ‰“å¡è¨˜éŒ„</p>';
                }
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥æœ¬é€±è¨˜éŒ„å¤±æ•—:', error);
            }
        }

        // ==================== å¿«æ·åŠŸèƒ½ ====================
        
        function openSalary() {
            liff.openWindow({
                url: 'https://eric693.github.io/New_Attendance-System/salary.html',
                external: false
            });
        }

        function openLeave() {
            liff.openWindow({
                url: 'https://eric693.github.io/New_Attendance-System/leave.html',
                external: false
            });
        }

        function openOvertime() {
            liff.openWindow({
                url: 'https://eric693.github.io/New_Attendance-System/overtime.html',
                external: false
            });
        }

        function openWeb() {
            liff.openWindow({
                url: 'https://eric693.github.io/New_Attendance-System/index.html',
                external: true
            });
        }

        // ==================== äº‹ä»¶ç¶å®š ====================
        
        document.getElementById('punch-in-btn').addEventListener('click', () => doPunch('ä¸Šç­'));
        document.getElementById('punch-out-btn').addEventListener('click', () => doPunch('ä¸‹ç­'));
        document.getElementById('face-punch-btn').addEventListener('click', doFacePunch);

        // ==================== åˆå§‹åŒ– ====================
        
        window.addEventListener('load', initializeLIFF);
    </script>
</body>
</html>